<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Company Account</title>

    <link rel="stylesheet" type="text/css" href="/static/engineer/css/company_style.css">
</head>

<body>
    <header>
        <nav>
            <a href="/">
                <div id="logo">
                    <h1 id="initials">FS</h1>
                    <h1 id="title">Material<br>Analysis</h1>
                </div>
            </a>

        </nav>
    </header>
    <main>
        <div class="sidebar">
            <a href="/orders" class="current-page">Order Queue</a>
            <a href="/new_order">New Orders</a>
            <a href="/companies">Company List</a>
            <a href="/contacts">Contact List</a>

        </div>

        <div class="main-content">

            <section class="section" id="add-form">
                
                <div class="card card--pad" id="forms-card">
                    <h2>Add Account</h2>
                    <form id="add-form">
                        <div class="form-section" id="company-details">
                            
                            <div class="form-input">
                                <label for="name">Name:</label><br>
                                <input type="text" id="name" name="name">
                            </div>
                            <div class="form-input">
                                <label for="email">Email:</label><br>
                                <input type="email" id="email" name="email">
                            </div>
                            <div class="form-input">
                                <label for="phone">Phone:</label><br>
                                <input type="text" id="phone" name="phone">
                            </div>
                            <div class="form-input">
                                <label for="status">Status:</label><br>
                                <select id="status" name="status">
                                    <option value=1>Active</option>
                                    <option value=2>Inactive</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-section" id="address">

                            <div class="form-input">
                                <label for="street">Street:</label><br>
                                <input type="text" id="street" name="street">
                            </div>
                            <div class="form-input">
                                <label for="city">City:</label><br>
                                <input type="text" id="city" name="city">
                            </div>
                            <div class="form-input">
                                <label for="state">State:</label><br>
                                <input type="text" id="state" name="state">
                            </div>
                            <div class="form-input">
                                <label for="zip">Zip Code:</label><br>
                                <input type="text" id="zip" name="zip">
                            </div>

                        </div>
                        <div class="form-section" id="buttons">
                            <input type="submit" id="submit">
                            
                        </div>
                    </form>
                </div>
            </section>

            <section class="section">
                
                <div class="card card--pad" id="company_accounts">
                    <h2>Company Accounts</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Status</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Actions</th>
                            </tr>

                        </thead>
                        <tbody id="company_accounts_table">

                        </tbody>
                    </table>
                </div>
            </section>
        </div>

    </main>
    <footer>
        <p>&copy; 2023 Company Name. All rights reserved.</p>
    </footer>
    <script>

        function openEdit(id) {
            document.querySelectorAll('.collapsible.open').forEach(el => {
                if (el.id !== id) el.classList.remove('open');
            });
            document.getElementById(id).classList.toggle('open');
        }

        function toggleElement(elementId) {
            const element = document.getElementById(elementId);

            element.classList.toggle("open");

        }

        // <----------- Load company accounts data ------------>
        const loadCompanyAccounts = () => {
            fetch('/company_accounts')
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    const tableBody = document.getElementById("company_accounts_table");
                    tableBody.innerHTML = '';

                    data.forEach(company => {
                        // Fill table
                        const row = document.createElement('tr');
                        const editRow = document.createElement('tr');
                        const editPanel = `edit-panel-${company.id}`
                        const address = `${company.addresses[0].street}, ${company.addresses[0].city}, ${company.addresses[0].state}, ${company.addresses[0].zip}`;

                        row.id = `row-${company.id}`;
                        editRow.id = `edit-row-${company.id}`;
                        editRow.classList.add('edit-row');

                        row.innerHTML = `
                            <td>${company.name}</td>
                            <td>${company.status}</td>
                            <td>${company.email}</td>
                            <td>${company.phone}</td>
                            <td>${address}</td>
                            <td>
                                <div class="actions">
                                    <button class="edit-button" onclick="openEdit('${editPanel}')">Edit</button>
                                    <button class="delete-button" onclick="deleteCompanyForm(${company.id})">Delete</button>
                                </div>
                            </td>
                            `;

                        editRow.innerHTML = `
                            <td colspan='6'>
                                <div id="${editPanel}" class="collapsible">
                                <form class="edit-form">
                                    <div class="form-section">
                                        <div class="form-input" style="display: none;">
                                            <input type="hidden" id="edit-id-${company.id}" name="id" value="${company.id}"><br>
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-name-${company.id}">Company Name:</label><br>
                                            <input type="text" id="edit-name-${company.id}" name="name" value="${company.name}">
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-status-${company.id}">Status:</label><br>
                                            <select id="edit-status-${company.id}" name="status">
                                                <option value=1 ${company.status_id === 1 ? 'selected' : ''}>Active</option>
                                                <option value=2 ${company.status_id === 2 ? 'selected' : ''}>Inactive</option>
                                            </select>
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-email-${company.id}">Email:</label><br>
                                            <input type="email" id="edit-email-${company.id}" name="email" value="${company.email}">
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-phone-${company.id}">Phone:</label><br>
                                            <input type="text" id="edit-phone-${company.id}" name="phone" value="${company.phone}">
                                        </div>
                                    </div>
                                    <div class="form-section">
                                        <div class="form-input">
                                            <label for="edit-street-${company.id}">Street:</label><br>
                                            <input type="text" id="edit-street-${company.id}" name="street" value="${company.addresses[0].street}">
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-city-${company.id}">City:</label><br>
                                            <input type="text" id="edit-city-${company.id}" name="city" value="${company.addresses[0].city}">
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-state-${company.id}">State:</label><br>
                                            <input type="text" id="edit-state-${company.id}" name="state" value="${company.addresses[0].state}">
                                        </div>
                                        <div class="form-input">
                                            <label for="edit-zip-${company.id}">Zip Code:</label><br>
                                            <input type="text" id="edit-zip-${company.id}" name="zip" value="${company.addresses[0].zip}">
                                        </div>
                                    </div>
                                    <div class="form-section edit-form-actions">
                                       <input type="submit" id="submit" class="edit-submit-button" value="Save">
                                       <button type="button" class="edit-cancel-button" onclick="toggleElement('${editPanel}')">Cancel</button>
                                    </div>
                                </form>
                                </div>
                            </td>
                        `;

                        tableBody.appendChild(row);
                        tableBody.appendChild(editRow);
                        submitEdits(editRow, ".edit-form");
                    });
                });
        };
        loadCompanyAccounts();

        // <------------- Add Company Form submission handler --------------->
        document.getElementById("add-form").addEventListener("submit", function (event) {
            event.preventDefault();
            // Handle form submission
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            console.log(data);
            fetch('/new_company_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    console.log("Company account added successfully");
                    loadCompanyAccounts();
                    event.target.reset();
                } else {
                    console.error("Error adding company account");
                }
            });
        });

        // Edit Company Form submission handler
        function submitEdits(parent, className) {
            const form = parent.querySelector(className);
            form.addEventListener("submit", function (event) {
                event.preventDefault();

                // Handle form submission
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData);
                console.log(data);
                fetch('/update_company_account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(response => {
                    if (response.ok) {
                        console.log("Company account edited successfully");
                        parent.style.display = 'none';
                        loadCompanyAccounts();
                        event.target.reset();
                    } else {
                        console.error("Error editing company account");
                    }
                });
            });
        };

        // Delete Company Account
        const deleteCompanyForm = (companyId) => {
            if (confirm("Are you sure you want to delete this company account?")) {
                fetch('/delete_company_account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: companyId })
                }).then(response => {
                    if (response.ok) {
                        console.log("Company account deleted successfully");
                        loadCompanyAccounts();

                    } else {
                        console.error("Error deleting company account");
                    }
                });
            }
        }

    </script>
</body>

</html>