<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Contact Accounts</title>

    <link rel="stylesheet" type="text/css" href="/static/engineer/css/company_style.css">
</head>

<body>
    <header>
        <nav>
            <a href="/">
                <div id="logo">
                    <h1 id="initials">FS</h1>
                    <h1 id="title">Material<br>Analysis</h1>
                </div>
            </a>

        </nav>
    </header>
    <main>
        <div class="sidebar">
            <a href="/orders" >Order Queue</a>
            <a href="/new_order">New Orders</a>
            <a href="/companies">Company Accounts</a>
            <a href="/contacts" class="current-page">Contact List</a>

        </div>

        <div class="main-content">


            <section class="section" id="forms">
                <div class="card card--pad" id="forms-card">
                    <h1 class="section-title">Add New Contact</h1>
                    <form id="add-form">

                        <div class="form-section">

                            <div class="form-input">
                                <label for="first_name">First Name</label>
                                <input type="text" id="first_name" name="first_name">
                            </div>


                            <div class="form-input">
                                <label for="last_name">Last Name</label>
                                <input type="text" id="last_name" name="last_name">
                            </div>
                            <div class="form-input">
                                <label for="email">Email:</label>
                                <input type="email" id="email" name="email">
                            </div>
                            <div class="form-input">
                                <label for="phone">Phone:</label>
                                <input type="text" id="phone" name="phone">
                            </div>
                        </div>
                        <div class="form-section">
                            <div class="form-input">
                                <label for="company_id">Company Name</label>
                                <div id="company-input">
                                </div>
                            </div>
                            <div class="form-input">
                                <label for="team_id">Team</label>
                                <div id="team-input">

                                </div>
                            </div>
                            <div class="form-input">
                                <label for="job_role_id">Job Title</label>
                                <div id="job-role-input">

                                </div>
                            </div>
                            <div class="form-input">
                                <label for="status">Status:</label>
                                <select id="status" name="status">
                                    <option value=1>Active</option>
                                    <option value=2>Inactive</option>
                                </select><br>
                            </div>
                        </div>
                        <div class="form-section form-actions">
                            <input type="submit" class="submit-button">
                           
                        </div>
                    </form>
                </div>
            </section>
            <section class="section" id="contact-accounts">
                <div class="card card--pad" id="accounts">
                    <h1 class="section-title">Contact Accounts</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Status</th>
                                <th>Name</th>
                                <th>Title</th>
                                <th>Team</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data_table">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

    </main>
    <footer>
        <p>&copy; 2023 Company Name. All rights reserved.</p>
    </footer>
    <script>

        // Button handlers
        document.getElementById("add-button").addEventListener("click", function () { toggleElement('add-form') });
        document.getElementById("cancel-button").addEventListener("click", function () { toggleElement('add-form') });

        // Load account data on Open
        loadData();
        loadTeams('team-input');
        loadJobRoles('job-role-input');
        loadCompanies('company-input');
        // 
        function openEdit(id) {
            document.querySelectorAll('.collapsible.open').forEach(el => {
                if (el.id !== id) el.classList.remove('open');
            });
            document.getElementById(id).classList.toggle('open');
        }

        function toggleElement(elementId) {
            const element = document.getElementById(elementId);

            element.classList.toggle("open");

        }

        // Edit Form handler
        function submitEdits(parent, className) {
            const form = parent.querySelector(className);
            form.addEventListener("submit", function (event) {
                event.preventDefault();

                // Handle form submission
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData);
                console.log(data);
                fetch('/update_contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(response => {
                    if (response.ok) {
                        console.log("Contact account edited successfully");
                        parent.style.display = 'none';
                        loadData();
                        event.target.reset();
                    } else {
                        console.error("Error editing contact account");
                    }
                });
            });
        };

        // Delete Account Handler
        function deleteForm(itemId) {
            if (confirm("Are you sure you want to delete this contact account?")) {
                fetch('/delete_contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: itemId })
                }).then(response => {
                    if (response.ok) {
                        console.log("Contact account deleted successfully");
                        loadData();

                    } else {
                        console.error("Error deleting contact account");
                    }
                });
            }
        }

        // Load Account Data
        function loadData() {
            fetch('/contact_accounts')
                .then(response => response.json())
                .then(data => {


                    const tableBody = document.getElementById("data_table");
                    tableBody.innerHTML = '';

                    data.forEach(item => {
                        // Fill table
                        const row = document.createElement('tr');
                        const editRow = document.createElement('tr');
                        const editPanel = `edit-panel-${item.id}`

                        row.id = `row-${item.id}`;
                        editRow.id = `edit-row-${item.id}`;
                        editRow.classList.add('edit-row');

                        row.innerHTML = `
                            <td>${item.company}</td>
                            <td>${item.status}</td>
                            <td>${item.first_name} ${item.last_name}</td>
                            <td>${item.job_role_name}</td>
                            <td>${item.team_name}</td>                      
                            <td>${item.email}</td>
                            <td>${item.phone}</td>
                           
                            <td>
                                <div class="actions">
                                    <button class="edit-button" onclick="openEdit('${editPanel}')">Edit</button>
                                    <button class="delete-button" onclick="deleteForm(${item.id})">Delete</button>
                                </div>
                            </td>
                            `;

                        editRow.innerHTML = `
                            <td colspan='8'>
                                <div id="${editPanel}" class="collapsible">
                                <form class="edit-form">
                                    <div class="edit-form-details">

                                        <div class="field" style="display: none;">
                                            <input type="hidden" id="edit-id-${item.id}" name="id" value="${item.id} "><br>
                                        </div>
                                        <div class="field">
                                            <label for="edit-fname-${item.id}">First Name:</label><br>
                                            <input type="text" id="edit-fname-${item.id}" name="first_name" value="${item.first_name}"><br>
                                        </div>
                                        <div class="field">
                                            <label for="edit-lname-${item.id}">Last Name:</label><br>
                                            <input type="text" id="edit-lname-${item.id}" name="last_name" value="${item.last_name}"><br>
                                        </div>
                                        <div class="field">
                                            <label for="edit-status-${item.id}">Status:</label><br>
                                            <select id="edit-status-${item.id}" name="status">
                                                <option value=1 ${item.status_id === 1 ? 'selected' : ''}>Active</option>
                                                <option value=2 ${item.status_id === 2 ? 'selected' : ''}>Inactive</option>
                                            </select>
                                        </div>
                                        <div class="field">
                                            <label for="edit-email-${item.id}">Email:</label><br>
                                            <input type="email" id="edit-email-${item.id}" name="email" value="${item.email}"><br>
                                        </div>
                                        <div class="field">
                                            <label for="edit-phone-${item.id}">Phone:</label><br>
                                            <input type="text" id="edit-phone-${item.id}" name="phone" value="${item.phone}"><br>
                                        </div>
                                        <div class="field">
                                            <label for="edit-company-${item.id}">Company:</label><br>
                                            <div id="edit-company-${item.id}">

                                            </div>
                                        </div>
                                        <div class="field">
                                            <label for="edit-team-${item.id}">Team:</label><br>
                                            <div id="edit-team-${item.id}">

                                            </div>
                                        </div>
                                        <div class="field">
                                            <label for="edit-title-${item.id}">Title:</label><br>
                                            <div id="edit-title-${item.id}">

                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                       <input type="submit" id="submit" class="submit-button" value="Save">
                                       <button type="button" class="edit-cancel-button" onclick="toggleElement('${editPanel}')">Cancel</button>
                                    </div>
                                </form>
                                </div>
                            </td>
                        `;

                        tableBody.appendChild(row);
                        tableBody.appendChild(editRow);
                        submitEdits(editRow, ".edit-form");
                        loadCompanies(`edit-company-${item.id}`, item.company_id);
                        loadTeams(`edit-team-${item.id}`, item.team_id);
                        loadJobRoles(`edit-title-${item.id}`, item.job_role_id);
                    });
                });
        };

        // Add Form Handler
        document.getElementById("add-form").addEventListener("submit",
            function (event) {
                event.preventDefault();
                // Handle form submission
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData);
                console.log(data);
                fetch('/new_contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(response => {
                    if (response.ok) {
                        console.log("Contact account added successfully");
                        loadData();
                        event.target.reset();
                    } else {
                        console.error("Error adding contact account");
                    }
                });
            });

        // Load List of companies
        async function loadCompanies(element, selectId) {
            try {
                // Fetch data and log to confirm data came through
                const response = await fetch('/contact_accounts/companies');
                const data = await response.json();

                // Add the select input and options to the add form 
                const inputDiv = document.getElementById(element);
                const inputElement = document.createElement('select');
                inputElement.id = 'company_id'
                inputElement.name = 'company_id'

                data.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    inputElement.appendChild(option);


                })
                inputElement.value = selectId;
                inputDiv.appendChild(inputElement);
            }
            catch (err) {
                console.error("Failed to load companies:", err)
            }
        }

        // Load List of Teams
        async function loadTeams(element, selectId) {
            try {
                // Fetch data and log to confirm data came through
                const response = await fetch('/contact_accounts/teams');
                const data = await response.json();

                // Add the select input and options to the add form 
                const inputDiv = document.getElementById(element);
                const inputElement = document.createElement('select');
                inputElement.id = 'team_id'
                inputElement.name = 'team_id'

                data.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    inputElement.appendChild(option)


                })
                inputElement.value = selectId;
                inputDiv.appendChild(inputElement);
            }
            catch (err) {
                console.error("Failed to load teams:", err)
            }
        }

        // Load list of Job Roles
        async function loadJobRoles(element, selectId) {
            try {
                const response = await fetch('/contact_accounts/job_roles')
                const data = await response.json();

                // Add the select input and options to the add form 
                const inputDiv = document.getElementById(element);
                const inputElement = document.createElement('select');
                inputElement.id = 'job_role_id'
                inputElement.name = 'job_role_id'

                data.forEach(jobRole => {
                    const option = document.createElement('option');
                    option.value = jobRole.id;
                    option.textContent = jobRole.name;
                    inputElement.appendChild(option)

                })
                inputElement.value = selectId;
                inputDiv.appendChild(inputElement);
            }
            catch (err) {
                console.error("Failed to load Job Roles:", err)
            }
        }
    </script>
</body>

</html>